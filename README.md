# PharmMate Database Documentation

## Overview
This database serves as the backend for the PharmMate price comparison application. It aggregates and unifies product, price, and promotion data from three major Israeli pharmacy retailers: Super-Pharm, Good Pharm, and Be Pharm.

## Core Architectural Concept
The system uses a two-pronged data strategy to ensure both data quality for the user interface and data completeness for price points.

1. **Canonical Product Catalog**: A master `canonical_products` table serves as the single source of truth for all product information. It is populated by dedicated commercial web scrapers that extract high-quality data like clean names, brands, descriptions, and images. The barcode is the Primary Key, ensuring a unique record for every physical product.

2. **Government Price Data**: The existing government data ETLs run in parallel to process high-volume, store-level price and promotion files.

The barcode acts as the universal key to link the price data from the government portals to the clean, user-facing data in the canonical catalog.

## Data Flow Diagram
```
[Commercial Scrapers (Super-Pharm, Be Pharm, etc.)]
        |
        v
+------------------------+
|  canonical_products    |  <-- (Populated with clean data, barcode is PK)
| (The "Face" of Products) |
+------------------------+
        ^
        | (Linked via retailer_products table)
        |
[Government ETLs (Super-Pharm, Good Pharm, Be Pharm)]
        |
        v
+------------------------+
| prices, promotions     |
| (High-volume price data) |
+------------------------+
```

## Key Table Schemas

This section describes the core tables in the final architecture. Redundant or deprecated tables from the old schema should be removed over time.

### canonical_products (The New Master Table)
This table stores the "golden record" for every unique product in the system and replaces the legacy products and canonical_products_clean tables. Data in this table is used for the app's UI.

| Column | Type | Description |
|--------|------|------------|
| barcode | VARCHAR(255) | PRIMARY KEY. The unique product barcode. |
| name | TEXT | The clean, high-quality product name. |
| brand | VARCHAR(255) | The product's manufacturer or brand. |
| description | TEXT | Detailed product description. |
| image_url | TEXT | URL for a high-resolution product image. |
| source_retailer_id | INTEGER | FK to the retailers table for data sourcing. |
| last_scraped_at | TIMESTAMPTZ | When this record was last updated by a scraper. |

### retailer_products
This is a crucial link table connecting a canonical product (via its barcode) to a retailer's internal product code.

| Column | Type | Description |
|--------|------|------------|
| retailer_product_id | INTEGER | PRIMARY KEY. |
| barcode | VARCHAR(255) | FK to the canonical_products table. |
| retailer_id | INTEGER | FK to the retailers table. |
| retailer_item_code | VARCHAR(100) | The retailer's internal ID for the product. |
| original_retailer_name | TEXT | The raw product name from the retailer's file. |

### prices
This table stores all historical price points from the government data feeds.

| Column | Type | Description |
|--------|------|------------|
| price_id | BIGINT | PRIMARY KEY. |
| retailer_product_id | INTEGER | FK to the retailer_products table. |
| store_id | INTEGER | FK to the stores table. |
| price | NUMERIC(10,2) | The price of the product. |
| price_timestamp | TIMESTAMPTZ | The timestamp from inside the source file. |
| scraped_at | TIMESTAMPTZ | Timestamp of when the ETL processed this record. |
| is_synthetic | BOOLEAN | True if the price was generated by our synthesis script. |

**Important Note**: The UNIQUE constraint on this table is on (retailer_product_id, store_id, price_timestamp, scraped_at) to allow for proper accumulation of historical price data.

### stores
Physical store locations for each retailer.

| Column | Type | Description |
|--------|------|------------|
| storeid | INTEGER | PRIMARY KEY. |
| retailerid | INTEGER | FK to retailers table. |
| retailerspecificstoreid | VARCHAR(50) | Retailer's internal store ID. |
| storename | VARCHAR(255) | Store name. |
| address | TEXT | Street address. |
| city | VARCHAR(100) | City. |
| latitude | NUMERIC(9,6) | GPS latitude. |
| longitude | NUMERIC(9,6) | GPS longitude. |
| isactive | BOOLEAN | Store active status. |

### retailers
Retailer/chain information.

| Column | Type | Description |
|--------|------|------------|
| retailerid | INTEGER | PRIMARY KEY. |
| retailername | VARCHAR(100) | Retailer name. |
| chainid | VARCHAR(50) | Chain identifier. |
| pricetransparencyportalurl | VARCHAR(255) | Price transparency URL. |
| fileformat | VARCHAR(20) | Data file format (XML/JSON). |

### promotions
Promotion definitions.

| Column | Type | Description |
|--------|------|------------|
| promotion_id | BIGINT | PRIMARY KEY. |
| retailer_id | INTEGER | FK to retailers table. |
| retailer_promotion_code | VARCHAR(100) | Retailer's promotion code. |
| description | TEXT | Promotion description. |
| start_date | TIMESTAMPTZ | Promotion start date. |
| end_date | TIMESTAMPTZ | Promotion end date. |

### promotion_product_links
Links products to promotions.

| Column | Type | Description |
|--------|------|------------|
| link_id | BIGINT | PRIMARY KEY. |
| promotion_id | BIGINT | FK to promotions table. |
| retailer_product_id | INTEGER | FK to retailer_products table. |

## Data Ingestion Workflow

1. **Scraping (Canonical Data)**: The commercial scrapers run periodically, populating/updating the `canonical_products` table.

2. **ETL (Price Data)**: The government data ETLs run daily.

3. **Linking**: For each product in a government file, the ETL uses the barcode to find its corresponding record in `canonical_products`. It then creates a link in `retailer_products` and inserts the price point into the `prices` table, associated with that link.

## Database Statistics (Current State)

### Overall
- **3 Active Pharmacy Chains**: Super-Pharm, Good Pharm, Be Pharm
- **577 Total Stores**: Across all three chains
- **43,919 Total Products**: Across all retailers
- **33,601 Unique Barcodes**: In the system
- **8,023 Shared Products**: Available at multiple retailers

### Per Retailer
| Retailer | Products | Stores | Coverage |
|----------|----------|--------|----------|
| Super-Pharm | 19,621 | 385 | Nationwide |
| Good Pharm | 12,275 | 83 | Major cities |
| Be Pharm | 12,023 | 109 | Urban areas |

## ETL Pipeline Scripts

### Commercial Web Scrapers
- `super_pharm_scraper.py` - Scrapes product catalog from Super-Pharm website
- `be_pharm_scraper.py` - Scrapes product catalog from Be Pharm website
- `good_pharm_scraper.py` - Scrapes product catalog from Good Pharm website

### Government Data ETLs
- `01_data_scraping_pipeline/super_pharm_barcode_matching.py` - Processes Super-Pharm government price files
- `01_data_scraping_pipeline/good_pharm_barcode_matching.py` - Processes Good Pharm government price files
- `01_data_scraping_pipeline/be_pharm_etl_refactored.py` - Processes Be Pharm government price files

### Data Synthesis
- `01_data_scraping_pipeline/be_pharm_price_synthesis.py` - Synthesizes missing Be Pharm price data

## Directory Structure
```
/PriceComparisonApp
├── 01_data_scraping_pipeline/   # ETL scripts
├── 02_backend_api/              # API server
├── 03_database/                 # Database schemas and migrations
├── 04_utilities/                # Helper scripts
├── 05_geocoding/                # Location services
├── 06_product_matching/         # Product matching algorithms
├── 07_testing/                  # Test scripts
├── 08_logs/                     # ETL logs
└── sample_files/                # Sample data files
```

## Migration Notes
The database is undergoing simplification from a complex multi-table product structure to a cleaner barcode-centric design. See `03_database/schema_migration.sql` for migration scripts.